<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="https://www.omg.org/spec/DMN/20191111/MODEL/"
             xmlns:dmndi="https://www.omg.org/spec/DMN/20191111/DMNDI/"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC/"
             xmlns:camunda="http://camunda.org/schema/1.0/dmn"
             id="billing-calculation-definitions"
             name="Billing Calculation Decision"
             namespace="http://hospital.com/dmn/billing"
             exporter="Camunda Modeler"
             exporterVersion="5.20.0">

  <decision id="billing-calculation" name="Cálculo de Faturamento">

    <decisionTable id="billing-table" hitPolicy="FIRST">

      <!-- ===== INPUT DEFINITIONS ===== -->
      <input id="input-procedure-type" label="Tipo de Procedimento" camunda:inputVariable="procedureType">
        <inputExpression id="input-expr-1" typeRef="string">
          <text>procedureType</text>
        </inputExpression>
        <inputValues id="input-values-1">
          <text>"SURGICAL","CLINICAL","DIAGNOSTIC","THERAPEUTIC","HOSPITALIZATION"</text>
        </inputValues>
      </input>

      <input id="input-insurance-table" label="Tabela de Preços" camunda:inputVariable="insuranceTable">
        <inputExpression id="input-expr-2" typeRef="string">
          <text>insuranceTable</text>
        </inputExpression>
        <inputValues id="input-values-2">
          <text>"SUS","AMB","CBHPM","BRASINDICE","SIMPRO","CUSTOM"</text>
        </inputValues>
      </input>

      <input id="input-base-value" label="Valor Base" camunda:inputVariable="baseValue">
        <inputExpression id="input-expr-3" typeRef="double">
          <text>baseValue</text>
        </inputExpression>
      </input>

      <input id="input-has-glosa" label="Tem Glosa" camunda:inputVariable="hasGlosa">
        <inputExpression id="input-expr-4" typeRef="boolean">
          <text>hasGlosa</text>
        </inputExpression>
      </input>

      <input id="input-glosa-percentage" label="Percentual de Glosa" camunda:inputVariable="glosaPercentage">
        <inputExpression id="input-expr-5" typeRef="double">
          <text>glosaPercentage</text>
        </inputExpression>
      </input>

      <!-- ===== OUTPUT DEFINITIONS ===== -->
      <output id="output-billable-amount" label="Valor Faturável" name="billableAmount" typeRef="double" />

      <output id="output-discount-applied" label="Desconto Aplicado" name="discountApplied" typeRef="double" />

      <output id="output-final-amount" label="Valor Final" name="finalAmount" typeRef="double" />

      <output id="output-calculation-rule" label="Regra Aplicada" name="calculationRule" typeRef="string" />

      <output id="output-needs-audit" label="Requer Auditoria" name="needsAudit" typeRef="boolean" />

      <!-- ===== DECISION RULES ===== -->

      <!-- RULE 1: Procedimento cirúrgico SUS -->
      <rule id="rule-surgical-sus">
        <description>Cirurgia com tabela SUS - valor fixo da tabela</description>
        <inputEntry id="rule1-input1">
          <text>"SURGICAL"</text>
        </inputEntry>
        <inputEntry id="rule1-input2">
          <text>"SUS"</text>
        </inputEntry>
        <inputEntry id="rule1-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule1-input4">
          <text>false</text>
        </inputEntry>
        <inputEntry id="rule1-input5">
          <text>-</text>
        </inputEntry>
        <outputEntry id="rule1-output1">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule1-output2">
          <text>0</text>
        </outputEntry>
        <outputEntry id="rule1-output3">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule1-output4">
          <text>"SUS_SURGICAL_BASE"</text>
        </outputEntry>
        <outputEntry id="rule1-output5">
          <text>false</text>
        </outputEntry>
      </rule>

      <!-- RULE 2: Procedimento com tabela AMB (20% acima da base) -->
      <rule id="rule-amb-table">
        <description>Tabela AMB com acréscimo de 20%</description>
        <inputEntry id="rule2-input1">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule2-input2">
          <text>"AMB"</text>
        </inputEntry>
        <inputEntry id="rule2-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule2-input4">
          <text>false</text>
        </inputEntry>
        <inputEntry id="rule2-input5">
          <text>-</text>
        </inputEntry>
        <outputEntry id="rule2-output1">
          <text>baseValue * 1.20</text>
        </outputEntry>
        <outputEntry id="rule2-output2">
          <text>0</text>
        </outputEntry>
        <outputEntry id="rule2-output3">
          <text>baseValue * 1.20</text>
        </outputEntry>
        <outputEntry id="rule2-output4">
          <text>"AMB_TABLE_120"</text>
        </outputEntry>
        <outputEntry id="rule2-output5">
          <text>false</text>
        </outputEntry>
      </rule>

      <!-- RULE 3: Procedimento com tabela CBHPM (40% acima da base) -->
      <rule id="rule-cbhpm-table">
        <description>Tabela CBHPM com acréscimo de 40%</description>
        <inputEntry id="rule3-input1">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule3-input2">
          <text>"CBHPM"</text>
        </inputEntry>
        <inputEntry id="rule3-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule3-input4">
          <text>false</text>
        </inputEntry>
        <inputEntry id="rule3-input5">
          <text>-</text>
        </inputEntry>
        <outputEntry id="rule3-output1">
          <text>baseValue * 1.40</text>
        </outputEntry>
        <outputEntry id="rule3-output2">
          <text>0</text>
        </outputEntry>
        <outputEntry id="rule3-output3">
          <text>baseValue * 1.40</text>
        </outputEntry>
        <outputEntry id="rule3-output4">
          <text>"CBHPM_TABLE_140"</text>
        </outputEntry>
        <outputEntry id="rule3-output5">
          <text>false</text>
        </outputEntry>
      </rule>

      <!-- RULE 4: Glosa parcial aplicada (até 30%) -->
      <rule id="rule-partial-glosa">
        <description>Glosa parcial - desconto do percentual glosado</description>
        <inputEntry id="rule4-input1">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule4-input2">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule4-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule4-input4">
          <text>true</text>
        </inputEntry>
        <inputEntry id="rule4-input5">
          <text>&gt; 0, &lt;= 30</text>
        </inputEntry>
        <outputEntry id="rule4-output1">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule4-output2">
          <text>baseValue * (glosaPercentage / 100)</text>
        </outputEntry>
        <outputEntry id="rule4-output3">
          <text>baseValue * (1 - (glosaPercentage / 100))</text>
        </outputEntry>
        <outputEntry id="rule4-output4">
          <text>"PARTIAL_GLOSA"</text>
        </outputEntry>
        <outputEntry id="rule4-output5">
          <text>true</text>
        </outputEntry>
      </rule>

      <!-- RULE 5: Glosa elevada (acima de 30%) - auditoria obrigatória -->
      <rule id="rule-high-glosa">
        <description>Glosa elevada requer auditoria detalhada</description>
        <inputEntry id="rule5-input1">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule5-input2">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule5-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule5-input4">
          <text>true</text>
        </inputEntry>
        <inputEntry id="rule5-input5">
          <text>&gt; 30</text>
        </inputEntry>
        <outputEntry id="rule5-output1">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule5-output2">
          <text>baseValue * (glosaPercentage / 100)</text>
        </outputEntry>
        <outputEntry id="rule5-output3">
          <text>baseValue * (1 - (glosaPercentage / 100))</text>
        </outputEntry>
        <outputEntry id="rule5-output4">
          <text>"HIGH_GLOSA_AUDIT_REQUIRED"</text>
        </outputEntry>
        <outputEntry id="rule5-output5">
          <text>true</text>
        </outputEntry>
      </rule>

      <!-- RULE 6: Internação hospitalar - cálculo por diária -->
      <rule id="rule-hospitalization">
        <description>Internação com cálculo baseado em diárias</description>
        <inputEntry id="rule6-input1">
          <text>"HOSPITALIZATION"</text>
        </inputEntry>
        <inputEntry id="rule6-input2">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule6-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule6-input4">
          <text>false</text>
        </inputEntry>
        <inputEntry id="rule6-input5">
          <text>-</text>
        </inputEntry>
        <outputEntry id="rule6-output1">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule6-output2">
          <text>0</text>
        </outputEntry>
        <outputEntry id="rule6-output3">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule6-output4">
          <text>"HOSPITALIZATION_DAILY"</text>
        </outputEntry>
        <outputEntry id="rule6-output5">
          <text>false</text>
        </outputEntry>
      </rule>

      <!-- RULE 7: Procedimento diagnóstico com tabela BRASINDICE -->
      <rule id="rule-diagnostic-brasindice">
        <description>Exames diagnósticos com tabela BRASINDICE (10% acima da base)</description>
        <inputEntry id="rule7-input1">
          <text>"DIAGNOSTIC"</text>
        </inputEntry>
        <inputEntry id="rule7-input2">
          <text>"BRASINDICE"</text>
        </inputEntry>
        <inputEntry id="rule7-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule7-input4">
          <text>false</text>
        </inputEntry>
        <inputEntry id="rule7-input5">
          <text>-</text>
        </inputEntry>
        <outputEntry id="rule7-output1">
          <text>baseValue * 1.10</text>
        </outputEntry>
        <outputEntry id="rule7-output2">
          <text>0</text>
        </outputEntry>
        <outputEntry id="rule7-output3">
          <text>baseValue * 1.10</text>
        </outputEntry>
        <outputEntry id="rule7-output4">
          <text>"BRASINDICE_DIAGNOSTIC_110"</text>
        </outputEntry>
        <outputEntry id="rule7-output5">
          <text>false</text>
        </outputEntry>
      </rule>

      <!-- RULE 8: Fallback - cálculo padrão sem modificadores -->
      <rule id="rule-default-calculation">
        <description>Cálculo padrão sem tabelas especiais ou glosas</description>
        <inputEntry id="rule8-input1">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule8-input2">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule8-input3">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule8-input4">
          <text>-</text>
        </inputEntry>
        <inputEntry id="rule8-input5">
          <text>-</text>
        </inputEntry>
        <outputEntry id="rule8-output1">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule8-output2">
          <text>0</text>
        </outputEntry>
        <outputEntry id="rule8-output3">
          <text>baseValue</text>
        </outputEntry>
        <outputEntry id="rule8-output4">
          <text>"STANDARD_CALCULATION"</text>
        </outputEntry>
        <outputEntry id="rule8-output5">
          <text>false</text>
        </outputEntry>
      </rule>

    </decisionTable>
  </decision>

  <!-- ===== DIAGRAM LAYOUT ===== -->
  <dmndi:DMNDI>
    <dmndi:DMNDiagram id="DMNDiagram_billing">
      <dmndi:DMNShape id="DMNShape_billing" dmnElementRef="billing-calculation">
        <dc:Bounds height="80" width="180" x="160" y="100" />
      </dmndi:DMNShape>
    </dmndi:DMNDiagram>
  </dmndi:DMNDI>

</definitions>
